!function(){"use strict";var e="",r="",a="dfnew_account_settings_v2";function n(e){return document.getElementById(e)}var t=n("createEmail"),s=n("createPassword"),i=n("createUsername"),o=n("loginEmail"),l=n("loginPassword"),c=n("newUsername"),u=n("newPassword"),d=n("createAccountBtn"),v=n("signInBtn"),_=n("signOutBtn"),k=n("changeUsernameBtn"),m=n("changePasswordBtn"),f=n("createPanel"),g=n("loginPanel"),p=n("usernamePanel"),y=n("status"),h=n("sessionSummary"),w={email:"",localId:"",idToken:"",refreshToken:"",level_server_account_username:"",level_server_auth_token:"",level_server_url:r,api_key:e};function T(e){return(e||"").replace(/[^a-zA-Z0-9_-]/g,"").slice(0,48)}function S(e,r){y&&(y.textContent=e,y.className="status","ok"===r&&y.classList.add("ok"),"err"===r&&y.classList.add("err"))}function E(){w.api_key=e,w.level_server_url=r,localStorage.setItem(a,JSON.stringify(w))}function I(){if(h){var e=[];e.push("email: "+(w.email||"<none>")),e.push("localId: "+(w.localId||"<none>")),e.push("username: "+(w.level_server_account_username||"<none>")),e.push("server: "+w.level_server_url),e.push("token: "+(w.level_server_auth_token?"configured":"<none>")),e.push("api_key: "+(w.api_key&&"REPLACE_WITH_FIREBASE_WEB_API_KEY"!==w.api_key?"configured":"<placeholder>")),h.textContent=e.join("\n")}}function P(){var e=!(!w.idToken||!w.level_server_auth_token);f&&(f.style.display=e?"none":""),g&&(g.style.display=e?"none":""),p&&(p.style.display=e?"":"none")}async function N(r,a){var n=(w.api_key=e,w.api_key?w.api_key:(S("Firebase API key missing in api.json.","err"),""));if(!n)throw new Error("Missing API key");var t="https://identitytoolkit.googleapis.com/v1/"+r+"?key="+encodeURIComponent(n),s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await s.text(),o={};try{o=i?JSON.parse(i):{}}catch(e){}if(!s.ok){var l=o&&o.error&&o.error.message?o.error.message:"HTTP "+s.status;throw new Error(l)}return o}function b(e){w.email=e.email||w.email||"",w.localId=e.localId||w.localId||"",w.idToken=e.idToken||w.idToken||"",w.refreshToken=e.refreshToken||w.refreshToken||"",w.level_server_auth_token=w.idToken||"",E(),I(),P()}d&&d.addEventListener("click",async function(){var e=(t.value||"").trim(),r=s.value||"",a=T(i.value||"");if(e&&r)if(a){S("Creating account...");try{b(await N("accounts:signUp",{email:e,password:r,returnSecureToken:!0})),w.level_server_account_username=a,b(await N("accounts:update",{idToken:w.idToken,displayName:a,returnSecureToken:!0})),E(),I(),S("Account created and username set.","ok")}catch(e){S("Create account failed: "+String(e.message||e),"err")}}else S("Username is required.","err");else S("Create account requires email + password.","err")}),v&&v.addEventListener("click",async function(){var e=(o.value||"").trim(),r=l.value||"";if(e&&r){S("Signing in...");try{var a=await N("accounts:signInWithPassword",{email:e,password:r,returnSecureToken:!0});b(a),a.displayName&&!w.level_server_account_username&&(w.level_server_account_username=T(a.displayName)),E(),I(),S("Signed in.","ok")}catch(e){S("Sign in failed: "+String(e.message||e),"err")}}else S("Sign in requires email + password.","err")}),_&&_.addEventListener("click",function(){w.email="",w.localId="",w.idToken="",w.refreshToken="",w.level_server_auth_token="",E(),I(),P(),S("Signed out locally.","ok")}),k&&k.addEventListener("click",async function(){var e=T(c.value||"");if(w.idToken)if(e){S("Changing username...");try{b(await N("accounts:update",{idToken:w.idToken,displayName:e,returnSecureToken:!0})),w.level_server_account_username=e,E(),I(),S("Username changed.","ok")}catch(e){S("Username change failed: "+String(e.message||e),"err")}}else S("New username is empty.","err");else S("Sign in first.","err")}),m&&m.addEventListener("click",async function(){var e=u&&u.value||"";if(w.idToken)if(!e||e.length<6)S("New password must be at least 6 characters.","err");else{S("Changing password...");try{b(await N("accounts:update",{idToken:w.idToken,password:e,returnSecureToken:!0})),u&&(u.value=""),E(),I(),S("Password changed.","ok")}catch(e){S("Password change failed: "+String(e.message||e),"err")}}else S("Sign in first.","err")});var C=function(){var e=localStorage.getItem(a);if(!e)return null;try{return JSON.parse(e)}catch(e){return null}}();!async function(){await async function(){try{var a=await fetch("./api.json",{method:"GET"}),n=await a.text();if(!a.ok)throw new Error("HTTP "+a.status);var t=n?JSON.parse(n):{};t&&t.firebase&&"object"==typeof t.firebase&&("string"==typeof t.firebase.api_key&&(e=t.firebase.api_key.trim()),"string"==typeof t.firebase.level_server_url&&(r=t.firebase.level_server_url.trim().replace(/\/+$/,"")))}catch(e){S("Failed to load api.json config.","err")}}(),C&&(w=Object.assign(w,C)),r&&(w.level_server_url=r),w.api_key=e,E(),I(),P(),S("Ready.")}()}();